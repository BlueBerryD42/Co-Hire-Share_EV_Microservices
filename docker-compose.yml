name: co-ownership-vehicle

x-common-environment: &common-env
  ASPNETCORE_ENVIRONMENT: Development
  DB_SERVER: host.docker.internal

x-dotnet-service: &dotnet-service
  env_file:
    - .env
  environment:
    <<: *common-env
  deploy:
    resources:
      limits:
        memory: 512M
        cpus: '0.5'
      reservations:
        memory: 128M
        cpus: '0.2'
  develop:
    watch:
      - action: sync
        path: ./src
        target: /src
        ignore:
          - node_modules/
          - bin/
          - obj/
          - "**/bin/"
          - "**/obj/"
          - "**/*.user"
          - "**/*.suo"
          - "**/.vs/"
          - "**/TestResults/"
          - "**/coverage/"
      - action: rebuild
        path: "./src/**/*.csproj"
      - action: sync
        path: "./src/**/*.cs"
        target: /src

services:
  api-gateway:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Infrastructure/ApiGateway/CoOwnershipVehicle.ApiGateway/CoOwnershipVehicle.ApiGateway.csproj
        APP_DLL: CoOwnershipVehicle.ApiGateway.dll
    depends_on:
      - auth-api
      - user-api
      - group-api
      - vehicle-api
      - payment-api
      - booking-api
      - admin-api
      - analytics-api
      - notification-api
    ports:
      - "61600:8080"
    networks:
      - coownership
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'

  auth-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Auth/CoOwnershipVehicle.Auth.Api/CoOwnershipVehicle.Auth.Api.csproj
        APP_DLL: CoOwnershipVehicle.Auth.Api.dll
    ports:
      - "61601:8080"
    networks:
      - coownership
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'

  user-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/User/CoOwnershipVehicle.User.Api/CoOwnershipVehicle.User.Api.csproj
        APP_DLL: CoOwnershipVehicle.User.Api.dll
    ports:
      - "61602:8080"
    networks:
      - coownership
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'

  group-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Group/CoOwnershipVehicle.Group.Api/CoOwnershipVehicle.Group.Api.csproj
        APP_DLL: CoOwnershipVehicle.Group.Api.dll
    ports:
      - "61603:8080"
    environment:
      <<: *common-env
      SIGNATURE_REMINDER_BASE_URL: "http://localhost:61600"  # Use API Gateway for external access
    networks:
      - coownership
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: '0.75'
        reservations:
          memory: 256M
          cpus: '0.2'

  vehicle-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Vehicle/CoOwnershipVehicle.Vehicle.Api/CoOwnershipVehicle.Vehicle.Api.csproj
        APP_DLL: CoOwnershipVehicle.Vehicle.Api.dll
    ports:
      - "61604:8080"
    networks:
      - coownership
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'

  payment-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Payment/CoOwnershipVehicle.Payment.Api/CoOwnershipVehicle.Payment.Api.csproj
        APP_DLL: CoOwnershipVehicle.Payment.Api.dll
    ports:
      - "61605:8080"
    networks:
      - coownership
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.15'

  booking-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Booking/CoOwnershipVehicle.Booking.Api/CoOwnershipVehicle.Booking.Api.csproj
        APP_DLL: CoOwnershipVehicle.Booking.Api.dll
    ports:
      - "61606:8080"
    networks:
      - coownership
    deploy:
      resources:
        limits:
          memory: 768M
          cpus: '0.75'
        reservations:
          memory: 256M
          cpus: '0.2'

  admin-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Admin/CoOwnershipVehicle.Admin.Api/CoOwnershipVehicle.Admin.Api.csproj
        APP_DLL: CoOwnershipVehicle.Admin.Api.dll
    ports:
      - "61607:8080"
    networks:
      - coownership
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'

  analytics-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Analytics/CoOwnershipVehicle.Analytics.Api/CoOwnershipVehicle.Analytics.Api.csproj
        APP_DLL: CoOwnershipVehicle.Analytics.Api.dll
    ports:
      - "61608:8080"
    networks:
      - coownership
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.2'

  notification-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Notification/CoOwnershipVehicle.Notification.Api/CoOwnershipVehicle.Notification.Api.csproj
        APP_DLL: CoOwnershipVehicle.Notification.Api.dll
    ports:
      - "61609:8080"
    networks:
      - coownership
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.15'

networks:
  coownership:
    driver: bridge
