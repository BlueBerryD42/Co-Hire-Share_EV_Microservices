{
  "info": {
    "name": "Vehicle Member Usage API Tests",
    "description": "Complete test suite for Vehicle Member Usage Analysis endpoint with automated validation",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. Auth - Login to get token",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has accessToken\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('accessToken');",
              "    pm.expect(jsonData.accessToken).to.be.a('string');",
              "    pm.expect(jsonData.accessToken.length).to.be.greaterThan(0);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    pm.collectionVariables.set(\"jwt_token\", jsonData.accessToken);",
              "    pm.collectionVariables.set(\"user_id\", jsonData.user.id);",
              "    console.log(\"Token saved: \" + jsonData.accessToken.substring(0, 50) + \"...\");",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"admin@coev.com\",\n  \"password\": \"Admin123!\"\n}"
        },
        "url": {
          "raw": "{{auth_base_url}}/api/auth/login",
          "host": ["{{auth_base_url}}"],
          "path": ["api", "auth", "login"]
        }
      },
      "response": []
    },
    {
      "name": "2. Get Member Usage - Default (Last 3 Months)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has required fields\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('vehicleId');",
              "    pm.expect(jsonData).to.have.property('vehicleName');",
              "    pm.expect(jsonData).to.have.property('plateNumber');",
              "    pm.expect(jsonData).to.have.property('startDate');",
              "    pm.expect(jsonData).to.have.property('endDate');",
              "    pm.expect(jsonData).to.have.property('totalDays');",
              "    pm.expect(jsonData).to.have.property('memberUsages');",
              "    pm.expect(jsonData).to.have.property('fairness');",
              "    pm.expect(jsonData).to.have.property('visualization');",
              "    pm.expect(jsonData).to.have.property('trends');",
              "});",
              "",
              "pm.test(\"Member usages array exists\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.memberUsages).to.be.an('array');",
              "});",
              "",
              "pm.test(\"Total days is approximately 90\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.totalDays).to.be.at.least(85);",
              "    pm.expect(jsonData.totalDays).to.be.at.most(95);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"]
        },
        "description": "Get member usage for last 3 months (default)"
      },
      "response": []
    },
    {
      "name": "3. Get Member Usage - Last 6 Months",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Total days is approximately 180\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.totalDays).to.be.at.least(175);",
              "    pm.expect(jsonData.totalDays).to.be.at.most(190);",
              "});",
              "",
              "pm.test(\"Date range is correct\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.startDate).to.include('2024-05-01');",
              "    pm.expect(jsonData.endDate).to.include('2024-11-03');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage?startDate=2024-05-01&endDate=2024-11-03",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"],
          "query": [
            {
              "key": "startDate",
              "value": "2024-05-01"
            },
            {
              "key": "endDate",
              "value": "2024-11-03"
            }
          ]
        },
        "description": "Get member usage for custom date range (6 months)"
      },
      "response": []
    },
    {
      "name": "4. Get Member Usage - Full Year 2024",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Full year 2024 data (366 days)\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.totalDays).to.equal(366);",
              "});",
              "",
              "pm.test(\"Date range covers full year\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.startDate).to.include('2024-01-01');",
              "    pm.expect(jsonData.endDate).to.include('2024-12-31');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage?startDate=2024-01-01&endDate=2024-12-31",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"],
          "query": [
            {
              "key": "startDate",
              "value": "2024-01-01"
            },
            {
              "key": "endDate",
              "value": "2024-12-31"
            }
          ]
        },
        "description": "Get member usage for full year 2024"
      },
      "response": []
    },
    {
      "name": "5. Verify Member Usage Breakdown",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Each member has complete usage data\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.memberUsages).to.be.an('array');",
              "    if (jsonData.memberUsages.length > 0) {",
              "        var member = jsonData.memberUsages[0];",
              "        pm.expect(member).to.have.property('memberId');",
              "        pm.expect(member).to.have.property('memberName');",
              "        pm.expect(member).to.have.property('ownershipPercentage');",
              "        pm.expect(member).to.have.property('numberOfTrips');",
              "        pm.expect(member).to.have.property('totalDistanceDriven');",
              "        pm.expect(member).to.have.property('totalTimeUsed');",
              "        pm.expect(member).to.have.property('percentageOfTotalUsage');",
              "        pm.expect(member).to.have.property('averageTripLength');",
              "        pm.expect(member).to.have.property('averageTripDuration');",
              "        pm.expect(member).to.have.property('usageToOwnershipRatio');",
              "        pm.expect(member).to.have.property('fairnessDelta');",
              "        pm.expect(member).to.have.property('usageStatus');",
              "        pm.expect(member).to.have.property('preferredDaysOfWeek');",
              "        pm.expect(member).to.have.property('preferredHoursOfDay');",
              "    }",
              "});",
              "",
              "pm.test(\"Usage status is valid\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.memberUsages.length > 0) {",
              "        jsonData.memberUsages.forEach(function(member) {",
              "            pm.expect(member.usageStatus).to.be.oneOf(['Fair', 'Overutilizing', 'Underutilizing']);",
              "        });",
              "    }",
              "});",
              "",
              "pm.test(\"Members sorted by usage (highest first)\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.memberUsages.length > 1) {",
              "        for (var i = 0; i < jsonData.memberUsages.length - 1; i++) {",
              "            pm.expect(jsonData.memberUsages[i].percentageOfTotalUsage)",
              "              .to.be.at.least(jsonData.memberUsages[i+1].percentageOfTotalUsage);",
              "        }",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"]
        },
        "description": "Verify member usage breakdown contains all required fields"
      },
      "response": []
    },
    {
      "name": "6. Verify Fairness Analysis",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Fairness analysis exists\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.fairness).to.be.an('object');",
              "    pm.expect(jsonData.fairness).to.have.property('averageFairnessScore');",
              "    pm.expect(jsonData.fairness.averageFairnessScore).to.be.a('number');",
              "});",
              "",
              "pm.test(\"Fairness score is valid (0-100)\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.fairness.averageFairnessScore).to.be.at.least(0);",
              "    pm.expect(jsonData.fairness.averageFairnessScore).to.be.at.most(100);",
              "});",
              "",
              "pm.test(\"Fairness components exist\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.fairness).to.have.property('memberScores');",
              "    pm.expect(jsonData.fairness).to.have.property('overutilizers');",
              "    pm.expect(jsonData.fairness).to.have.property('underutilizers');",
              "    pm.expect(jsonData.fairness).to.have.property('fairnessRecommendations');",
              "    pm.expect(jsonData.fairness.memberScores).to.be.an('array');",
              "    pm.expect(jsonData.fairness.overutilizers).to.be.an('array');",
              "    pm.expect(jsonData.fairness.underutilizers).to.be.an('array');",
              "    pm.expect(jsonData.fairness.fairnessRecommendations).to.be.an('array');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"]
        },
        "description": "Verify fairness analysis with scores and recommendations"
      },
      "response": []
    },
    {
      "name": "7. Verify Visualization Data",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Visualization data exists\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.visualization).to.be.an('object');",
              "    pm.expect(jsonData.visualization).to.have.property('usagePieChart');",
              "    pm.expect(jsonData.visualization).to.have.property('tripsByMember');",
              "    pm.expect(jsonData.visualization).to.have.property('distanceByMember');",
              "    pm.expect(jsonData.visualization).to.have.property('timeByMember');",
              "});",
              "",
              "pm.test(\"Chart data points have required fields\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.visualization.usagePieChart.length > 0) {",
              "        var point = jsonData.visualization.usagePieChart[0];",
              "        pm.expect(point).to.have.property('label');",
              "        pm.expect(point).to.have.property('value');",
              "        pm.expect(point).to.have.property('color');",
              "        pm.expect(point.color).to.match(/^#[0-9A-Fa-f]{6}$/);",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"]
        },
        "description": "Verify visualization data for charts"
      },
      "response": []
    },
    {
      "name": "8. Verify Usage Trends",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Trends data exists\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.trends).to.be.an('array');",
              "});",
              "",
              "pm.test(\"Trend direction is valid\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.trends.length > 0) {",
              "        jsonData.trends.forEach(function(memberTrend) {",
              "            pm.expect(memberTrend).to.have.property('memberId');",
              "            pm.expect(memberTrend).to.have.property('memberName');",
              "            pm.expect(memberTrend).to.have.property('trendDirection');",
              "            pm.expect(memberTrend).to.have.property('dataPoints');",
              "            pm.expect(memberTrend.trendDirection).to.be.oneOf(['Increasing', 'Stable', 'Decreasing']);",
              "            pm.expect(memberTrend.dataPoints).to.be.an('array');",
              "        });",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"]
        },
        "description": "Verify usage trends over time"
      },
      "response": []
    },
    {
      "name": "9. ERROR - Vehicle Not Found (404)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 404\", function () {",
              "    pm.response.to.have.status(404);",
              "});",
              "",
              "pm.test(\"Error message is present\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('message');",
              "    pm.expect(jsonData.message).to.include('not found');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/00000000-0000-0000-0000-000000000000/member-usage",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "00000000-0000-0000-0000-000000000000", "member-usage"]
        },
        "description": "Test with non-existent vehicle ID - should return 404"
      },
      "response": []
    },
    {
      "name": "10. ERROR - Unauthorized (401)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 401\", function () {",
              "    pm.response.to.have.status(401);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"]
        },
        "description": "Test without authorization token - should return 401"
      },
      "response": []
    },
    {
      "name": "11. ERROR - Invalid Token (401)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 401\", function () {",
              "    pm.response.to.have.status(401);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer invalid_token_here",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"]
        },
        "description": "Test with invalid token - should return 401"
      },
      "response": []
    },
    {
      "name": "12. Verify Calculations - Usage Percentages",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Usage percentages add up correctly\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.memberUsages && jsonData.memberUsages.length > 0) {",
              "        var totalUsage = 0;",
              "        var totalTrips = 0;",
              "        jsonData.memberUsages.forEach(function(member) {",
              "            totalUsage += member.percentageOfTotalUsage;",
              "            totalTrips += member.numberOfTrips;",
              "        });",
              "        ",
              "        // If there are trips, percentages should add to 100%",
              "        // If no trips, percentages should all be 0",
              "        if (totalTrips > 0) {",
              "            pm.expect(totalUsage).to.be.closeTo(100, 0.5);",
              "        } else {",
              "            pm.expect(totalUsage).to.equal(0);",
              "        }",
              "    }",
              "});",
              "",
              "pm.test(\"Fairness delta is accurate\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.memberUsages && jsonData.memberUsages.length > 0) {",
              "        jsonData.memberUsages.forEach(function(member) {",
              "            var expectedDelta = member.percentageOfTotalUsage - member.ownershipPercentage;",
              "            pm.expect(member.fairnessDelta).to.be.closeTo(expectedDelta, 0.1);",
              "        });",
              "    }",
              "});",
              "",
              "pm.test(\"Usage to ownership ratio is correct\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.memberUsages && jsonData.memberUsages.length > 0) {",
              "        jsonData.memberUsages.forEach(function(member) {",
              "            if (member.ownershipPercentage > 0) {",
              "                var expectedRatio = member.percentageOfTotalUsage / member.ownershipPercentage;",
              "                pm.expect(member.usageToOwnershipRatio).to.be.closeTo(expectedRatio, 0.1);",
              "            }",
              "        });",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"]
        },
        "description": "Verify that calculations (percentages, ratios, deltas) are mathematically accurate"
      },
      "response": []
    },
    {
      "name": "13. Edge Case - Invalid Date Range",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200 (Graceful handling)\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has valid structure despite invalid dates\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.be.an('object');",
              "    pm.expect(jsonData).to.have.property('memberUsages');",
              "    pm.expect(jsonData).to.have.property('fairness');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage?startDate=2025-12-31&endDate=2025-01-01",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"],
          "query": [
            {
              "key": "startDate",
              "value": "2025-12-31"
            },
            {
              "key": "endDate",
              "value": "2025-01-01"
            }
          ]
        },
        "description": "Test with endDate before startDate - should handle gracefully"
      },
      "response": []
    },
    {
      "name": "14. Edge Case - Empty Date Range (No Bookings)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Returns empty usage with zero values\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('memberUsages');",
              "    pm.expect(jsonData.memberUsages).to.be.an('array');",
              "    ",
              "    if (jsonData.memberUsages.length > 0) {",
              "        jsonData.memberUsages.forEach(function(member) {",
              "            pm.expect(member.numberOfTrips).to.equal(0);",
              "            pm.expect(member.totalDistanceDriven).to.equal(0);",
              "            pm.expect(member.totalTimeUsed).to.equal(0);",
              "        });",
              "    }",
              "});",
              "",
              "pm.test(\"Fairness analysis exists even with no data\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.fairness).to.be.an('object');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/member-usage?startDate=2020-01-01&endDate=2020-01-31",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "member-usage"],
          "query": [
            {
              "key": "startDate",
              "value": "2020-01-01"
            },
            {
              "key": "endDate",
              "value": "2020-01-31"
            }
          ]
        },
        "description": "Test with date range that has no bookings - should return empty usage"
      },
      "response": []
    }
  ],
  "variable": [
    {
      "key": "base_url",
      "value": "https://localhost:61603",
      "type": "string"
    },
    {
      "key": "auth_base_url",
      "value": "https://localhost:61601",
      "type": "string"
    },
    {
      "key": "vehicle_id",
      "value": "75134495-27c4-43a9-a549-5624cc91352d",
      "type": "string"
    },
    {
      "key": "jwt_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "user_id",
      "value": "",
      "type": "string"
    }
  ]
}
