name: co-ownership-vehicle

x-common-environment: &common-env
  ASPNETCORE_ENVIRONMENT: Development
  DB_SERVER: host.docker.internal

x-dotnet-service: &dotnet-service
  env_file:
    - .env
  environment:
    <<: *common-env

services:
  api-gateway:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Infrastructure/ApiGateway/CoOwnershipVehicle.ApiGateway/CoOwnershipVehicle.ApiGateway.csproj
        APP_DLL: CoOwnershipVehicle.ApiGateway.dll
    depends_on:
      - auth-api
      - user-api
      - group-api
      - vehicle-api
      - payment-api
      - booking-api
      - admin-api
      - analytics-api
      - notification-api
    ports:
      - "61600:8080"
    networks:
      - coownership

  auth-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Auth/CoOwnershipVehicle.Auth.Api/CoOwnershipVehicle.Auth.Api.csproj
        APP_DLL: CoOwnershipVehicle.Auth.Api.dll
    ports:
      - "61601:8080"
    environment:
      <<: *common-env
    networks:
      - coownership

  user-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/User/CoOwnershipVehicle.User.Api/CoOwnershipVehicle.User.Api.csproj
        APP_DLL: CoOwnershipVehicle.User.Api.dll
    ports:
      - "61602:8080"
    environment:
      <<: *common-env
    networks:
      - coownership

  group-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Group/CoOwnershipVehicle.Group.Api/CoOwnershipVehicle.Group.Api.csproj
        APP_DLL: CoOwnershipVehicle.Group.Api.dll
    ports:
      - "61603:8080"
    environment:
      <<: *common-env
      SIGNATURE_REMINDER_BASE_URL: "https://localhost:61600" # Use API Gateway for external access
      FileStorage__LocalStoragePath: "/app/storage/documents"
    volumes:
      - group-documents:/app/storage/documents
    networks:
      - coownership

  vehicle-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Vehicle/CoOwnershipVehicle.Vehicle.Api/CoOwnershipVehicle.Vehicle.Api.csproj
        APP_DLL: CoOwnershipVehicle.Vehicle.Api.dll
    ports:
      - "61604:8080"
    environment:
      <<: *common-env
      GroupService__BaseUrl: "http://group-api:8080"
    networks:
      - coownership

  payment-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Payment/CoOwnershipVehicle.Payment.Api/CoOwnershipVehicle.Payment.Api.csproj
        APP_DLL: CoOwnershipVehicle.Payment.Api.dll
    ports:
      - "61605:8080"
    environment:
      <<: *common-env
      GROUP_SERVICE_URL: "http://group-api:8080"
      USER_SERVICE_URL: "http://user-api:8080"
      # VNPay Configuration
      VNPAY_TMN_CODE: ${VNPAY_TMN_CODE}
      VNPAY_HASH_SECRET: ${VNPAY_HASH_SECRET}
      VNPAY_PAYMENT_URL: ${VNPAY_PAYMENT_URL}
      VNPAY_RETURN_URL: ${VNPAY_RETURN_URL}
    networks:
      - coownership

  booking-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Booking/CoOwnershipVehicle.Booking.Api/CoOwnershipVehicle.Booking.Api.csproj
        APP_DLL: CoOwnershipVehicle.Booking.Api.dll
    ports:
      - "61606:8080"
    environment:
      <<: *common-env
    networks:
      - coownership

  admin-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Admin/CoOwnershipVehicle.Admin.Api/CoOwnershipVehicle.Admin.Api.csproj
        APP_DLL: CoOwnershipVehicle.Admin.Api.dll
    ports:
      - "61607:8080"
    environment:
      <<: *common-env
      DB_ADMIN: CoOwnershipVehicle_Admin
    networks:
      - coownership

  analytics-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Analytics/CoOwnershipVehicle.Analytics.Api/CoOwnershipVehicle.Analytics.Api.csproj
        APP_DLL: CoOwnershipVehicle.Analytics.Api.dll
    ports:
      - "61608:8080"
    environment:
      <<: *common-env
    networks:
      - coownership

  notification-api:
    <<: *dotnet-service
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PROJECT: src/Services/Notification/CoOwnershipVehicle.Notification.Api/CoOwnershipVehicle.Notification.Api.csproj
        APP_DLL: CoOwnershipVehicle.Notification.Api.dll
    ports:
      - "61609:8080"
    environment:
      <<: *common-env
    networks:
      - coownership

networks:
  coownership:
    driver: bridge

volumes:
  group-documents:
    driver: local
