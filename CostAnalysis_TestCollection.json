{
  "info": {
    "name": "Vehicle Cost Analysis API Tests",
    "description": "Complete test suite for Vehicle Cost Analysis endpoint with automated validation",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "1. Auth - Login to get token",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has accessToken\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('accessToken');",
              "    pm.expect(jsonData.accessToken).to.be.a('string');",
              "    pm.expect(jsonData.accessToken.length).to.be.greaterThan(0);",
              "});",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    pm.collectionVariables.set(\"jwt_token\", jsonData.accessToken);",
              "    console.log(\"Token saved: \" + jsonData.accessToken.substring(0, 50) + \"...\");",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"admin@coev.com\",\n  \"password\": \"Admin123!\"\n}"
        },
        "url": {
          "raw": "{{auth_base_url}}/api/auth/login",
          "host": ["{{auth_base_url}}"],
          "path": ["api", "auth", "login"]
        }
      },
      "response": []
    },
    {
      "name": "2. Get Cost Analysis - Default (Last 1 Year)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has required fields\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('vehicleId');",
              "    pm.expect(jsonData).to.have.property('vehicleName');",
              "    pm.expect(jsonData).to.have.property('expenseBreakdown');",
              "    pm.expect(jsonData).to.have.property('totalCosts');",
              "    pm.expect(jsonData).to.have.property('costPerUnit');",
              "    pm.expect(jsonData).to.have.property('costTrends');",
              "    pm.expect(jsonData).to.have.property('depreciation');",
              "    pm.expect(jsonData).to.have.property('roi');",
              "    pm.expect(jsonData).to.have.property('suggestions');",
              "});",
              "",
              "pm.test(\"Expense breakdown has 8 categories\", function () {",
              "    var jsonData = pm.response.json();",
              "    var breakdown = jsonData.expenseBreakdown;",
              "    pm.expect(breakdown).to.have.property('maintenanceCosts');",
              "    pm.expect(breakdown).to.have.property('insuranceCosts');",
              "    pm.expect(breakdown).to.have.property('registrationLicensingCosts');",
              "    pm.expect(breakdown).to.have.property('chargingFuelCosts');",
              "    pm.expect(breakdown).to.have.property('cleaningCosts');",
              "    pm.expect(breakdown).to.have.property('repairCosts');",
              "    pm.expect(breakdown).to.have.property('parkingTollsCosts');",
              "    pm.expect(breakdown).to.have.property('otherCosts');",
              "});",
              "",
              "pm.test(\"Suggestions array exists\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.suggestions).to.be.an('array');",
              "    pm.expect(jsonData.suggestions.length).to.be.at.least(1);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/cost-analysis",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "cost-analysis"]
        },
        "description": "Get cost analysis for last 1 year with monthly grouping (default)"
      },
      "response": []
    },
    {
      "name": "3. Get Cost Analysis - Last 6 Months",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Total days is approximately 180\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.totalDays).to.be.at.least(175);",
              "    pm.expect(jsonData.totalDays).to.be.at.most(185);",
              "});",
              "",
              "pm.test(\"Date range is correct\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.startDate).to.include('2024-05-01');",
              "    pm.expect(jsonData.endDate).to.include('2024-11-01');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/cost-analysis?startDate=2024-05-01&endDate=2024-11-01&groupBy=month",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "cost-analysis"],
          "query": [
            {
              "key": "startDate",
              "value": "2024-05-01"
            },
            {
              "key": "endDate",
              "value": "2024-11-01"
            },
            {
              "key": "groupBy",
              "value": "month"
            }
          ]
        },
        "description": "Get cost analysis for last 6 months with monthly grouping"
      },
      "response": []
    },
    {
      "name": "4. Get Cost Analysis - Quarterly Grouping",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Cost trends are grouped quarterly\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.costTrends).to.be.an('array');",
              "    if (jsonData.costTrends.length > 0) {",
              "        pm.expect(jsonData.costTrends[0].period).to.match(/^Q[1-4] \\d{4}$/);",
              "    }",
              "});",
              "",
              "pm.test(\"Full year 2024 data (366 days)\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.totalDays).to.equal(366);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/cost-analysis?startDate=2024-01-01&endDate=2024-12-31&groupBy=quarter",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "cost-analysis"],
          "query": [
            {
              "key": "startDate",
              "value": "2024-01-01"
            },
            {
              "key": "endDate",
              "value": "2024-12-31"
            },
            {
              "key": "groupBy",
              "value": "quarter"
            }
          ]
        },
        "description": "Get full year 2024 analysis with quarterly grouping"
      },
      "response": []
    },
    {
      "name": "5. Get Cost Analysis - Yearly Grouping",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Cost trends are grouped yearly\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.costTrends).to.be.an('array');",
              "    if (jsonData.costTrends.length > 0) {",
              "        pm.expect(jsonData.costTrends[0].period).to.match(/^\\d{4}$/);",
              "    }",
              "});",
              "",
              "pm.test(\"Multi-year data\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.totalDays).to.be.greaterThan(365);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/cost-analysis?startDate=2022-01-01&endDate=2024-12-31&groupBy=year",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "cost-analysis"],
          "query": [
            {
              "key": "startDate",
              "value": "2022-01-01"
            },
            {
              "key": "endDate",
              "value": "2024-12-31"
            },
            {
              "key": "groupBy",
              "value": "year"
            }
          ]
        },
        "description": "Get 3-year analysis (2022-2024) with yearly grouping"
      },
      "response": []
    },
    {
      "name": "6. Get Cost Analysis - Monthly Grouping",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Cost trends are grouped monthly\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.costTrends).to.be.an('array');",
              "    if (jsonData.costTrends.length > 0) {",
              "        pm.expect(jsonData.costTrends[0].period).to.match(/^\\d{4}-\\d{2}$/);",
              "    }",
              "});",
              "",
              "pm.test(\"ROI analysis exists\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.roi).to.have.property('numberOfOwners');",
              "    pm.expect(jsonData.roi).to.have.property('totalCostPerOwner');",
              "    pm.expect(jsonData.roi).to.have.property('savingsPerOwner');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/cost-analysis?startDate=2024-01-01&endDate=2024-12-31&groupBy=month",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "cost-analysis"],
          "query": [
            {
              "key": "startDate",
              "value": "2024-01-01"
            },
            {
              "key": "endDate",
              "value": "2024-12-31"
            },
            {
              "key": "groupBy",
              "value": "month"
            }
          ]
        },
        "description": "Get full year 2024 analysis with monthly grouping (12 months)"
      },
      "response": []
    },
    {
      "name": "7. Verify Total Costs Calculation",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Total costs structure is correct\", function () {",
              "    var jsonData = pm.response.json();",
              "    var totalCosts = jsonData.totalCosts;",
              "    pm.expect(totalCosts).to.have.property('allTimeCost');",
              "    pm.expect(totalCosts).to.have.property('periodCost');",
              "    pm.expect(totalCosts).to.have.property('averageMonthlyCost');",
              "    pm.expect(totalCosts.allTimeCost).to.be.a('number');",
              "    pm.expect(totalCosts.periodCost).to.be.a('number');",
              "    pm.expect(totalCosts.averageMonthlyCost).to.be.a('number');",
              "});",
              "",
              "pm.test(\"Expense breakdown totals match\", function () {",
              "    var jsonData = pm.response.json();",
              "    var breakdown = jsonData.expenseBreakdown;",
              "    var total = breakdown.maintenanceCosts + breakdown.insuranceCosts + ",
              "                breakdown.registrationLicensingCosts + breakdown.chargingFuelCosts + ",
              "                breakdown.cleaningCosts + breakdown.repairCosts + ",
              "                breakdown.parkingTollsCosts + breakdown.otherCosts;",
              "    pm.expect(breakdown.totalExpenses).to.equal(total);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/cost-analysis",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "cost-analysis"]
        },
        "description": "Verify that calculations are accurate"
      },
      "response": []
    },
    {
      "name": "8. Verify Depreciation Analysis",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Depreciation analysis exists\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData.depreciation).to.be.an('object');",
              "    pm.expect(jsonData.depreciation).to.have.property('vehicleAgeMonths');",
              "    pm.expect(jsonData.depreciation.vehicleAgeMonths).to.be.a('number');",
              "});",
              "",
              "pm.test(\"Vehicle age is reasonable\", function () {",
              "    var jsonData = pm.response.json();",
              "    var ageMonths = jsonData.depreciation.vehicleAgeMonths;",
              "    pm.expect(ageMonths).to.be.at.least(0);",
              "    pm.expect(ageMonths).to.be.at.most(240); // Max 20 years",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/cost-analysis",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "cost-analysis"]
        },
        "description": "Verify depreciation calculations"
      },
      "response": []
    },
    {
      "name": "9. ERROR - Vehicle Not Found (404)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 404\", function () {",
              "    pm.response.to.have.status(404);",
              "});",
              "",
              "pm.test(\"Error message is present\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.have.property('message');",
              "    pm.expect(jsonData.message).to.include('not found');",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/00000000-0000-0000-0000-000000000000/cost-analysis",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "00000000-0000-0000-0000-000000000000", "cost-analysis"]
        },
        "description": "Test with non-existent vehicle ID - should return 404"
      },
      "response": []
    },
    {
      "name": "10. ERROR - Unauthorized (401)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 401\", function () {",
              "    pm.response.to.have.status(401);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/cost-analysis",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "cost-analysis"]
        },
        "description": "Test without authorization token - should return 401"
      },
      "response": []
    },
    {
      "name": "11. ERROR - Invalid Token (401)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 401\", function () {",
              "    pm.response.to.have.status(401);",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer invalid_token_here",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/cost-analysis",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "cost-analysis"]
        },
        "description": "Test with invalid token - should return 401"
      },
      "response": []
    },
    {
      "name": "12. Graceful Handling - Invalid GroupBy Parameter",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "pm.test(\"Status code is 200 (Graceful degradation)\", function () {",
              "    pm.response.to.have.status(200);",
              "});",
              "",
              "pm.test(\"Response has valid structure\", function () {",
              "    var jsonData = pm.response.json();",
              "    pm.expect(jsonData).to.be.an('object');",
              "    pm.expect(jsonData).to.have.property('costTrends');",
              "});",
              "",
              "pm.test(\"API defaults to monthly grouping for invalid value\", function () {",
              "    var jsonData = pm.response.json();",
              "    if (jsonData.costTrends && jsonData.costTrends.length > 0) {",
              "        // Invalid value should default to 'month' format: YYYY-MM",
              "        pm.expect(jsonData.costTrends[0].period).to.match(/^\\\\d{4}-\\\\d{2}$/);",
              "    }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{jwt_token}}",
            "type": "text"
          }
        ],
        "url": {
          "raw": "{{base_url}}/api/vehicle/{{vehicle_id}}/cost-analysis?groupBy=invalid_value",
          "host": ["{{base_url}}"],
          "path": ["api", "vehicle", "{{vehicle_id}}", "cost-analysis"],
          "query": [
            {
              "key": "groupBy",
              "value": "invalid_value"
            }
          ]
        },
        "description": "Test with invalid groupBy parameter - API handles gracefully by defaulting to 'month'"
      },
      "response": []
    }
  ],
  "variable": [
    {
      "key": "base_url",
      "value": "https://localhost:61603",
      "type": "string"
    },
    {
      "key": "auth_base_url",
      "value": "https://localhost:61601",
      "type": "string"
    },
    {
      "key": "vehicle_id",
      "value": "2296D6F7-F501-42D5-ABA9-56A3EBD835EC",
      "type": "string"
    },
    {
      "key": "jwt_token",
      "value": "",
      "type": "string"
    }
  ]
}
